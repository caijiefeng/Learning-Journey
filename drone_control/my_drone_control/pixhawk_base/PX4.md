# PX4
## 基础知识
### 了解无人机
无人机并不单单指无人驾驶的飞机，无人机其实是指无人驾驶的机器设备，这种机器设备可以进行远程或者自动控制，无人机最主要的就是它的自动驾驶仪，这种自动驾驶仪包含控制器硬件以及运行该硬件的软件组成。
### 了解PX4
PX4是一种开源的自动驾驶飞行栈，也是大型无人机平台的核心部分。
PX4可以做到控制不同的设备机架并且适用性、安全性极强。
一套完整的大型无人机平台应该包括QGroudControl地面站，Pixhawk硬件设备，MAVSDK和使用MAVLink协议的硬件设备。
### 了解QGroudControl
QGC地面站又称为Dronecode地面控制站，无人机控制站可以将PX4软件加载到飞行控制器硬件之中，可以通过在控制站中设置不同的参数等等给控制无人机，包括无人机航线规划、获取无人机实时飞行数据、接收命令、飞行或升降控制等等。
### 了解飞行控制板
PX4现在支持在Linux、Pixhawk系列以及其他硬件上运行，选择飞行控制板上需要充分考虑尺寸、运行效果以及成本。
简称飞控，飞控又称为飞行控制器，本质上是一块硬件电路板，可以根据相关指令解算出电机的推力进而控制无人机的飞行，内置有imu、气压计、罗盘等等，其中imu用来输出加速度信息，气压计用来输出无人机高度，罗盘可以辨别无人机的朝向。
[Pixhawk简介](https://zhuanlan.zhihu.com/p/41921881)
### 了解电调
电调称为电子调速器，简称ESC，用于把输入的控制信号转换成电流来控制电机旋转。
### 了解传感器
PX4中使用传感器来确定机体的状态，保持稳定并且完成自动控制。
* 陀螺仪：利用角动量不变的原理，用于维持方向不变，再将所指示的方向把数据信号传给控制系统。
* 空速计：对于固定翼和VTOL支架来说是必须的，用于维持升力的空速。
* 转速计：对于多旋翼支架，转速计可以实时反馈叶片转速，防止失速。
* 加速度计：将加速度转变为可输出信号的传感器。
* 磁力计：又称GPS、罗盘，可以检测机体周围磁场并实时反馈的传感器，可以输出飞行器此时的方向，此外，GPS的安装需要尽可能远离电机、电调来减少电磁波的干扰。
* 气压计：测量大气压强并转变为可输出信号的传感器，用于稳定飞行高度。
* 距离传感器：反馈距离，用于安全、精准着陆以及规避地形。
传感器的接线方法可以从飞控以及传感器本身的制造商文档中获取。
### 了解机架
* 多旋翼：精确悬停和垂直起落，但飞行时间短、飞行速度慢。
* 固定翼：飞行时间长、飞行速度快，但很难悬停以及垂直起落。
* VTOL：兼容了多旋翼和固定翼的优点，但组装、调试更困难，价格更高。
### 了解安全开关
无人机需要一个安全开关，只有解锁了安全开关之后电机才会供电，螺旋桨才会开始旋转，安全开关可以整合到GPS设备中，也可以是一个单独的物理组件。
### 了解数传电台
数传为控制站与运行PX4的载体计算机进行无线MAVLink通信，可以实现在飞行过程中对无人机进行调试。
### 了解SD卡
PX4使用SD卡来存储飞行日志，缺少SD卡时PX4将无法使用CAN通信的设备来执行飞行任务，Pixhawk最大支持32G的SD卡。
### 了解供电方式
为了减少安全事故，PX4提供了三种供电方式。
* Disarmed：此时执行器和电机都不会上电。
* Prearmed：电机不上电，执行器上电，一般用于调试一些没有安全风险的模块。
* Armd：电机和执行器都会上电，螺旋桨会开始旋转！
### 了解飞行模式
* 自主模式：由PX4自动控制执行一些预编程或者常见的任务。
* 手动模式：由飞行员自主操控执行任务，通过遥控器之类的。
### 了解航向、运动方向
每个车辆、机体都有自己的航向和运动方向，我们的自动驾驶仪必须要与车辆运动矢量对齐，哪怕多旋翼的飞行器四面八方都是对称的但它也有自己的航向。
通常将前进的方向规定为x轴，正对x轴方向右手指示的方向为y轴，而飞行中z轴通常朝下，rpy旋转轴中，roll是指绕x轴旋转即翻转，pitch轴是绕y轴旋转即俯仰，yaw轴是指绕z轴旋转即偏航，rpy与xyz是按顺序对应的。
### 了解安全模式
安全模式主要用于出现问题时保护、恢复车辆，你可以在安全模式中设定禁飞区域、高度，飞行速度之类的，并且可以设置违反后执行的操作。
通常出现以下情况后应当执行安全操作：
* 电量过低
* 与遥控器失去连接
* 于计算机失去连接
* 数据传输故障
* 高度过高或过低
记住！无人机所有一切都是安全第一！

---

## 初始配置

### 基本设备
PX4推荐的设备:
* Taranis Plus遥控器（或者同类产品）
* 带有ubuntu18.04或更高版本的电脑
* 可以运行PX4的车辆
* 护目镜
* 系绳（多旋翼飞行器）
### 车辆配置
首先确保你的电脑安装了QGC应用。
配置车辆需要你完成以下几个步骤:
* 加载PX4固件、自定义固件
-安装稳定的PX4，通常Pixhawk4飞控中已经加载了最新版本的PX4自动驾驶仪。QGC为我们提供了几个版本的PX4，包括自定义固件也可以通过QGC加载到飞控中。
-FMUv2引导程序的更新
* 从机架参考中匹配机身
-QGC中有一些品牌、型号的车辆（无人机）框架可供选择，如果你的车辆恰好符合，直接选择应用就好。如果没有对应的，也可以选择最接近的通用框架来适配车辆。
-运行QGC，依次点击 "Q" icon > Vehicle Setup > Airframe，选择适合的机身框架点击Apply应用，然后重启车辆。
-我们需要关注四旋翼的机架Quadrotor x，它有4个电机，在飞控安装方向（无人机前进方向）上的两个电机为1、3号电机，飞控安装方向反方向上的两个电机为2、4号电机，其中1、2号电机逆时针旋转，3、4号电机顺时针旋转，这是非常重要的！
* 基本配置
* 参数配置

---

## 机载计算机

PX4允许连接连接在任何串口上的机载计算机，并且使用MAVLink协议通信。
### Pixhawk4设置
PX4默认允许与连接在```TELEM2```串口上的机载计算机通信，如果你的计算机是连接在这个串口上，则不需要对PX4作额外的配置修改，如果不是连接在```TELEM2```上，那么就需要修改串口配置。
### 机载计算机设置
机载计算机并不能直接接收MAVLink并与飞控/PX4直接通信，而是通信一些与串口通信的软件:
* MAVROS:与ROS节点进行通信
* C/C++代码:连接自定义的代码
* MAVLink Router:在UDP和串口之间发送MAVLink
### 串口硬件设置
所有的Pixhawk产品都必须在3.3V下运行，而且兼容5V的电平。
许多现代的机载计算机在硬件UART上仅支持1.8V电平，容易3.3V电平损坏，需要使用电平转换器。

### 串行端口配置

Pixhawk上许多的串行端口可以通过参数进行完全配置：

* ```TELEM1```
* ```TELEM2```
* ```TELEM4```（```UART+I2C```）

这种配置包括了：

* 修改串口的波特率
* 在不同的端口上运行MAVLink
* 更改流式消息
* 设置双GPS
* 启用在串行端口上运行的传感器

默认情况下：

* MAVLink映射到 ```TELEM1``` 端口，波特率57600
* GPS1映射到 ```GPS1``` 端口并且将自动检测波特率
* MAVLink在具有以太网端口的Pixhawk设备上通过使用```MAV_2_CONFIG``` 来映射到以太网端口
* 所有其它的端口没有分配的功能（被禁用）

上述的端口映射可以通过修改 ```MAV_0_CONFIG``` 、```GPS_1_CONFIG```、```MAV_2_CONFIG``` 值为 *Disabled* 来禁用上述的端口映射。

---

## PX4 Tuning

以下参数必须设置后才可以使用EKF2的外部信息，打开QGC，点击左上角“Q”图标>选择”Vehicle Setup">选择"Parametres">选择"EKF2"中修改这些参数。

### EKF2_AID_MASK 

可手动将视觉摄像头与需要的数据融合的参数，每一位数字都独立控制是一种数据相融合，具体如下：

> 0：是否使用GPS
>
> 1：是否使用光流数据
>
> 2：是否禁止IMU偏差估计
>
> 3：是否进行视觉位置融合
>
> 4：是否进行视觉偏航融合
>
> 5：是否进行多旋翼拖曳融合
>
> 6：是否旋转外视
>
> 7：是否进行GPS偏航融合
>
> 8：是否进行视觉速度融合

这个参数设置后需要重启车辆才能生效。

### EKF2_HGT_MODE

确定EKF使用高度数据的主要来源，每一位数字都代表着不同的数据来源，具体如下：

> 0：气压计
>
> 1：GPS
>
> 2：距离传感器
>
> 3：视觉

这个参数设置后需要重启车辆生效。

### EKF2_EV_DELAY

视觉位置估计器对于相对于IMU测量的误差（也就是视觉系统时间戳和IMU时钟的差别），这个参数设置后需要重启车辆生效。

通常来讲，不存在两个系统能具有完全同步的时间戳，所以这个延迟需要一些经验调整，可以通过检查IMU速率以及EV速率之间的偏移量来粗略估计这个延迟，下面这张图很明显地表示了如何估计这个延迟：

![EKF2_EV_DELAY数值捕获](https://docs.px4.io/main/assets/img/ekf2_ev_delay_tuning.e77364d5.png)

### EKF2_EV_POS_X/Y/Z

VI传感器的焦点在车身框架中的X/Y/Z位置。这个如果在程序中设置了就不用修改，比如在vision_to_mavros和VIO配置文件中修改了相机参数那么这几个参数就不用再修改了。
